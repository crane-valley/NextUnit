name: .NET CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  # Job 1: Build with caching (shared by other jobs)
  build:
    name: Build & Code Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props', '**/Directory.Packages.props') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore NextUnit.CI.slnx

    - name: Build Release
      run: dotnet build NextUnit.CI.slnx --configuration Release --no-restore

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-output
        path: |
          src/**/bin/Release/
          samples/**/bin/Release/
          samples/**/obj/Release/**/NextUnit.Generator/
        retention-days: 1

  # Job 2: Run tests (uses build artifacts)
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props', '**/Directory.Packages.props') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Download build artifacts
      uses: actions/download-artifact@v7
      with:
        name: build-output
        path: .

    - name: Restore dependencies
      run: dotnet restore NextUnit.CI.slnx

    - name: Run NextUnit sample tests
      run: |
        dotnet run --project samples/NextUnit.SampleTests/NextUnit.SampleTests.csproj \
          --configuration Release \
          --no-build \
          -- --minimum-expected-tests 20

  # Job 3: Code quality checks (lightweight, no build needed)
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Check code formatting
      run: dotnet format NextUnit.slnx --verify-no-changes --verbosity minimal

    - name: Check required files
      run: |
        for file in README.md .editorconfig; do
          [ -f "$file" ] && echo "✓ $file" || { echo "✗ $file missing"; exit 1; }
        done

    - name: Check .editorconfig
      run: grep -q "root = true" .editorconfig && echo "✓ .editorconfig valid"

    - name: Verify project structure
      run: |
        for p in src/NextUnit.Core/NextUnit.Core.csproj \
                 src/NextUnit.Generator/NextUnit.Generator.csproj \
                 src/NextUnit.Platform/NextUnit.Platform.csproj \
                 samples/NextUnit.SampleTests/NextUnit.SampleTests.csproj; do
          [ -f "$p" ] && echo "✓ $p" || { echo "✗ $p missing"; exit 1; }
        done

  # Job 4: Security scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props', '**/Directory.Packages.props') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore NextUnit.CI.slnx

    - name: Check for vulnerable packages
      run: dotnet list NextUnit.CI.slnx package --vulnerable --include-transitive
      continue-on-error: true

  # Job 5: Verify generator output
  generator:
    name: Generator Validation
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Download build artifacts
      uses: actions/download-artifact@v7
      with:
        name: build-output
        path: .

    - name: Verify generator output exists
      run: |
        if find samples/NextUnit.SampleTests -name "*.g.cs" -type f 2>/dev/null | grep -q .; then
          echo "✓ Generator produced output"
          find samples/NextUnit.SampleTests -name "*.g.cs" -type f | head -5
        else
          echo "⚠️ No generated files found"
        fi

  # Summary job
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build, test, code-quality, security, generator]
    if: always()

    steps:
    - name: Check results
      run: |
        echo "=== CI Summary ==="
        echo "Build: ${{ needs.build.result }}"
        echo "Test: ${{ needs.test.result }}"
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo "Security: ${{ needs.security.result }}"
        echo "Generator: ${{ needs.generator.result }}"

        [[ "${{ needs.build.result }}" == "success" ]] || exit 1
        [[ "${{ needs.test.result }}" == "success" ]] || exit 1
        echo "✅ All critical checks passed"
