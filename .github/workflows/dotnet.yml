name: .NET CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  # Job 1: Build and analyze code quality
  build:
    name: Build & Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Display .NET info
      run: dotnet --info
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build (Debug)
      run: dotnet build --configuration Debug --no-restore
    
    - name: Build (Release)
      run: dotnet build --configuration Release --no-restore
    
    - name: Run code analysis
      run: dotnet build --configuration Release --no-restore /p:EnforceCodeStyleInBuild=true /p:TreatWarningsAsErrors=true
      continue-on-error: false

  # Job 2: Run tests with coverage
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --configuration Release --no-restore
    
    - name: Run tests
      run: dotnet test --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: '**/test-results.trx'
        retention-days: 30

  # Job 3: Verify documentation
  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check required documentation files
      run: |
        echo "Checking for required documentation files..."
        required_files=("README.md" "PLANS.md" "DEVLOG.md" "CODING_STANDARDS.md" ".editorconfig")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "Error: Required file $file not found"
            exit 1
          else
            echo "✓ Found $file"
          fi
        done
    
    - name: Validate markdown files
      uses: DavidAnson/markdownlint-cli2-action@v18
      with:
        globs: '**/*.md'
      continue-on-error: true
    
    - name: Check for non-English content in code files
      run: |
        echo "Checking for non-ASCII characters in code files (potential non-English content)..."
        # Search for non-ASCII characters in .cs files (excluding comments might have legitimate Unicode)
        if grep -r -P '[^\x00-\x7F]' --include="*.cs" src/ samples/ 2>/dev/null | grep -v "// " | grep -v "/// " | grep -v "/\*"; then
          echo "Warning: Found non-ASCII characters in code files"
          echo "Please review CODING_STANDARDS.md - All code must be in English"
          exit 0  # Warning only, don't fail the build
        else
          echo "✓ All code files use ASCII characters only"
        fi

  # Job 4: Verify project structure
  structure:
    name: Project Structure Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Verify project files exist
      run: |
        echo "Verifying project structure..."
        projects=(
          "src/NextUnit.Core/NextUnit.Core.csproj"
          "src/NextUnit.Generator/NextUnit.Generator.csproj"
          "src/NextUnit.Platform/NextUnit.Platform.csproj"
          "samples/NextUnit.SampleTests/NextUnit.SampleTests.csproj"
        )
        for project in "${projects[@]}"; do
          if [ ! -f "$project" ]; then
            echo "Error: Project file $project not found"
            exit 1
          else
            echo "✓ Found $project"
          fi
        done
    
    - name: Check for circular dependencies
      run: dotnet list reference
      working-directory: src/NextUnit.Core
      continue-on-error: true
    
    - name: Verify package references
      run: |
        echo "Checking NextUnit.Core dependencies..."
        dotnet list src/NextUnit.Core/NextUnit.Core.csproj package
        echo "Checking NextUnit.Generator dependencies..."
        dotnet list src/NextUnit.Generator/NextUnit.Generator.csproj package
        echo "Checking NextUnit.Platform dependencies..."
        dotnet list src/NextUnit.Platform/NextUnit.Platform.csproj package

  # Job 5: Security scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Check for vulnerable packages
      run: dotnet list package --vulnerable --include-transitive
      continue-on-error: true
    
    - name: Check for deprecated packages
      run: dotnet list package --deprecated
      continue-on-error: true

  # Job 6: Source generator validation
  generator:
    name: Source Generator Validation
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build generator
      run: dotnet build src/NextUnit.Generator/NextUnit.Generator.csproj --configuration Release --no-restore
    
    - name: Build sample tests (triggers generator)
      run: dotnet build samples/NextUnit.SampleTests/NextUnit.SampleTests.csproj --configuration Release --no-restore
    
    - name: Check generated files
      run: |
        echo "Checking for generated source files..."
        if find samples/NextUnit.SampleTests/obj -name "GeneratedTestRegistry.g.cs" -type f | grep -q .; then
          echo "✓ Source generator produced output"
          echo "Generated files:"
          find samples/NextUnit.SampleTests/obj -name "*.g.cs" -type f
        else
          echo "Warning: No generated files found. Generator may not be running."
          exit 1
        fi

  # Job 7: Performance baseline check
  performance:
    name: Performance Baseline
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build in Release mode
      run: dotnet build --configuration Release --no-restore
    
    - name: Run sample tests and measure time
      run: |
        echo "Running sample tests and measuring execution time..."
        start_time=$(date +%s%N)
        dotnet run --project samples/NextUnit.SampleTests/NextUnit.SampleTests.csproj --configuration Release --no-build
        end_time=$(date +%s%N)
        elapsed_ms=$(( (end_time - start_time) / 1000000 ))
        echo "Test execution time: ${elapsed_ms}ms"
        
        # Check against performance target (should be < 1000ms for 20 tests)
        if [ $elapsed_ms -gt 2000 ]; then
          echo "Warning: Test execution took longer than expected (>${elapsed_ms}ms)"
        else
          echo "✓ Performance within acceptable range"
        fi
      continue-on-error: true

  # Job 8: EditorConfig validation
  editorconfig:
    name: EditorConfig Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check .editorconfig exists
      run: |
        if [ -f ".editorconfig" ]; then
          echo "✓ .editorconfig found"
          cat .editorconfig
        else
          echo "Error: .editorconfig not found"
          exit 1
        fi
    
    - name: Validate .editorconfig format
      run: |
        echo "Validating .editorconfig format..."
        # Basic validation - check for root = true
        if grep -q "root = true" .editorconfig; then
          echo "✓ .editorconfig has root = true"
        else
          echo "Warning: .editorconfig should have 'root = true'"
        fi

  # Job 9: Final health check summary
  health-check:
    name: Health Check Summary
    runs-on: ubuntu-latest
    needs: [build, test, documentation, structure, security, generator, performance, editorconfig]
    if: always()
    
    steps:
    - name: Check job results
      run: |
        echo "=== CI Health Check Summary ==="
        echo "Build: ${{ needs.build.result }}"
        echo "Test: ${{ needs.test.result }}"
        echo "Documentation: ${{ needs.documentation.result }}"
        echo "Structure: ${{ needs.structure.result }}"
        echo "Security: ${{ needs.security.result }}"
        echo "Generator: ${{ needs.generator.result }}"
        echo "Performance: ${{ needs.performance.result }}"
        echo "EditorConfig: ${{ needs.editorconfig.result }}"
        
        if [ "${{ needs.build.result }}" != "success" ] || \
           [ "${{ needs.test.result }}" != "success" ] || \
           [ "${{ needs.structure.result }}" != "success" ] || \
           [ "${{ needs.generator.result }}" != "success" ]; then
          echo "❌ Critical checks failed"
          exit 1
        else
          echo "✅ All critical checks passed"
        fi
