name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true

jobs:
  # Job 1: PR metadata and changed files analysis (lightweight)
  pr-analysis:
    name: PR Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Check PR title format
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        if [[ "$PR_TITLE" =~ ^(feat|fix|docs|refactor|test|chore|perf|ci|build|style):\ .+ ]]; then
          echo "✓ PR title follows conventional format"
        else
          echo "⚠️ PR title should follow: type: description"
        fi

    - name: Analyze changed files
      run: |
        echo "=== Changed Files ==="
        git diff --name-only origin/main...HEAD
        echo ""
        echo "Core: $(git diff --name-only origin/main...HEAD | grep -c 'src/NextUnit.Core' || echo 0)"
        echo "Generator: $(git diff --name-only origin/main...HEAD | grep -c 'src/NextUnit.Generator' || echo 0)"
        echo "Tests: $(git diff --name-only origin/main...HEAD | grep -c 'samples/' || echo 0)"
        echo "Docs: $(git diff --name-only origin/main...HEAD | grep -c '\.md$' || echo 0)"

  # Job 2: Strict build with caching
  strict-build:
    name: Strict Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props', '**/Directory.Packages.props') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore NextUnit.CI.slnx

    - name: Build Release (strict mode)
      run: dotnet build NextUnit.CI.slnx --configuration Release --no-restore

    - name: Verify no warnings
      run: |
        dotnet build NextUnit.CI.slnx --configuration Release --no-restore 2>&1 | tee build.log
        if grep -E ": warning [A-Z]{2,}[0-9]+:" build.log; then
          echo "⚠️ Build warnings found"
          exit 1
        fi
        echo "✓ No build warnings"

  # Job 3: Code format check (lightweight)
  format-check:
    name: Code Format
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Check code formatting
      run: dotnet format --verify-no-changes --verbosity minimal

  # Job 4: Dependencies check (lightweight)
  dependency-check:
    name: Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Build.props', '**/Directory.Packages.props') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Check dependencies
      run: |
        dotnet restore NextUnit.CI.slnx
        echo "=== NextUnit.Core Dependencies ==="
        dotnet list src/NextUnit.Core/NextUnit.Core.csproj package

  # Summary
  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [pr-analysis, strict-build, format-check, dependency-check]
    if: always()

    steps:
    - name: Summary
      run: |
        echo "=== PR Validation Summary ==="
        echo "PR Analysis: ${{ needs.pr-analysis.result }}"
        echo "Strict Build: ${{ needs.strict-build.result }}"
        echo "Format Check: ${{ needs.format-check.result }}"
        echo "Dependencies: ${{ needs.dependency-check.result }}"

        [[ "${{ needs.strict-build.result }}" == "success" ]] || exit 1
        [[ "${{ needs.format-check.result }}" == "success" ]] || exit 1
        echo "✅ All PR checks passed"
